<!DOCTYPE HTML>
<html>

<head>
	<title>audizo</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,600,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Rokkitt:100,300,400,700" rel="stylesheet">

	<!-- Animate.css -->
	<link rel="stylesheet" href="/static/userImages/css/animate.css">
	<!-- Icomoon Icon Fonts-->
	<link rel="stylesheet" href="/static/userImages/css/icomoon.css">
	<!-- Ion Icon Fonts-->
	<link rel="stylesheet" href="/static/userImages/css/ionicons.min.css">
	<!-- Bootstrap  -->
	<link rel="stylesheet" href="/static/userImages/css/bootstrap.min.css">

	<!-- Magnific Popup -->
	<link rel="stylesheet" href="/static/userImages/css/magnific-popup.css">

	<!-- Flexslider  -->
	<link rel="stylesheet" href="/static/userImages/css/flexslider.css">

	<!-- Owl Carousel -->
	<link rel="stylesheet" href="/static/userImages/css/owl.carousel.min.css">
	<link rel="stylesheet" href="/static/userImages/css/owl.theme.default.min.css">

	<!-- Date Picker -->
	<link rel="stylesheet" href="/static/userImages/css/bootstrap-datepicker.css">
	<!-- Flaticons  -->
	<link rel="stylesheet" href="/static/userImages/fonts/flaticon/font/flaticon.css">

	<!-- Theme style  -->
	<link rel="stylesheet" href="/static/userImages/css/style.css">
	<style>
		.address-card-checkout {
			position: relative;
			padding-left: 40px;
			padding-bottom: 15px;
		}

		.address-radio {
			position: absolute;
			top: 10px;
			left: 10px;
		}

		.address-card-checkout label {
			display: block;
			margin-left: 30px;
		}
	</style>
</head>

<body>


	<div class="colorlib-loader"></div>

	<div id="page">
		<nav class="colorlib-nav" role="navigation">
			<div class="top-menu">
				<div class="container">
					<div class="row">
						<div class="col-sm-7 col-md-9">
							<div id="colorlib-logo"><a href="#">AUDIZO.</a></div>
						</div>
						<div class="col-sm-5 col-md-3">
							<form action="#" class="search-wrap">
								<div class="form-group">
									<input type="search" class="form-control search" placeholder="Search">
									<button class="btn btn-primary submit-search text-center" type="submit"><i
											class="icon-search"></i></button>
								</div>
							</form>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-12 text-left menu-1">
							<ul>
								<li><a href="/">Home</a></li>
								<li class="has-dropdown active">
									<a href="/shop">Shop</a>
									<ul class="dropdown">
										<li><a href="/shop">Shop Products</a></li>
										<li><a href="/cart">Shopping Cart</a></li>
										<!-- <li><a href="checkout.html">Checkout</a></li>
										<li><a href="order-complete.html">Order Complete</a></li> -->
										<li><a href="/wishlist">Wishlist</a></li>
									</ul>
								</li>
								<!-- <li><a href="women.html">Women</a></li> -->
								<li><a href="/about">About</a></li>
								<!-- <li><a href="contact.html">Contact</a></li> -->
								<li class="cart"><a href="/cart"><i class="icon-shopping-cart"></i> </a></li>
								<li class="cart"><a href="/wishlist"><i class="icon-heart"></i></a></li>
								<li class="cart"><a href="/profile"><i class="icon-user"></i>
										<%= user.name %>
									</a></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
			<div class="sale">
				<div class="container">
					<div class="row">
						<div class="col-sm-8 offset-sm-2 text-center">
							<div class="row">
								<div class="owl-carousel2">
									<div class="item">
										<div class="col">
											<h3><a href="#">25% off (Almost) Everything! Use Code: Summer Sale</a></h3>
										</div>
									</div>
									<div class="item">
										<div class="col">
											<h3><a href="#">Our biggest sale yet 50% off on all headphones</a></h3>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</nav>

		<div class="breadcrumbs">
			<div class="container">
				<div class="row">
					<div class="col">
						<p class="bread"><span><a href="/">Home</a></span> / <span><a href="/shop">Shop</a></span> /
							<span><a href="/cart">cart</a></span> / <span>Checkout</span>
						</p>
					</div>
				</div>
			</div>
		</div>


		<div class="colorlib-product">
			<div class="container">
				<div class="row row-pb-lg">
					<div class="col-sm-10 offset-md-1">
						<div class="process-wrap">
							<div class="process text-center active">
								<p><span>01</span></p>
								<h3>Shopping Cart</h3>
							</div>
							<div class="process text-center active">
								<p><span>02</span></p>
								<h3>Checkout</h3>
							</div>
							<div class="process text-center">
								<p><span>03</span></p>
								<h3>Order Complete</h3>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-8">
						<div class="container cart-detail">
							<h2>Delivery Address</h2>
							<div class="address-selection-checkout">
								<% if (addresses && addresses.address && addresses.address.length> 0) { %>
									<% addresses.address.map(function(item) { %>
										<div class="address-card-checkout"
											style="position: relative; padding-left: 40px; padding-bottom: 15px;">
											<input type="radio" id="address<%= item._id %>" value="<%= item._id %>"
												name="selectedAddress" class="address-radio"
												style="position: absolute; top: 10px; left: 10px;" />
											<label for="address<%= item._id %>"
												style="display: block; margin-left: 30px;">
												<p><strong>
														<%= item.name %>
													</strong></p>
												<p>
													<%= item.locality %>, <%= item.house %>, <%= item.city %>, <%=
																	item.state %>, <%= item.pincode %>
												</p>
												<p>Phone: <%= item.mobile %>
												</p>
											</label>
										</div>
										<hr>
										<% }); %>
											<% } else { %>
												<h3 style="color: gray; text-align: center">No address found!</h3>
												<% } %>
													<button
														style="width: 30%; border-radius: 10px; height: 50px; margin-top: 15px;"
														class="btn btn-primary" data-toggle="modal"
														data-target="#billingModal">
														Add Address
													</button>
							</div>
						</div>

					</div>

					<div class="col-lg-4">
						<div class="row">
							<div class="col-md-12">
								<div class="cart-detail">
									<h2>Cart Total</h2>
									<ul>
										<li>
											<span>Subtotal</span> <span>&#8377;<%= grandTotal %></span>
											<ul>
												<% cart.items.forEach(item=> { %>
													<li><span>
															<%= item.quantity %> x <%= item.productId.name %>
														</span> <span>&#8377;<%= item.quantity *
																item.productId.discountPrice %></span></li>
													<% }) %>
											</ul>
										</li>
										<!-- <li><span>Discount</span><span>â‚¹0</span></li> -->
										<li>
											<span>Shipping</span>
											<span>
												<span
													style="text-decoration: line-through; color: grey;">&#8377;40</span>
												<span style="color: green; margin-left: 31px;">Free</span>
											</span>
										</li>
										<li>
											<span>Order Total</span>
											<span>&#8377;<%= grandTotal %></span>
											<input type="hidden" name="totalprice" value="<%= grandTotal %>">
										</li>
									</ul>
								</div>
							</div>

							<div class="w-100"></div>

							<div class="col-md-12">
								<div class="cart-detail">
									<h2>Payment Method</h2>

									<div class="form-group">
										<div class="col-md-12">
											<div class="radio">
												<label for="payment"><input type="radio" id="payment"
														name="paymentMethod" value="cod"> Cash on
													Delivery</label><span class="text-danger" style="display: none;"
													id="codError"> cannot place cod over Rs:10000</span>
											</div>
										</div>
									</div>
									<div class="form-group">
										<div class="col-md-12">
											<div class="radio">
												<label for="payment"><input type="radio" id="razorpay"
														name="paymentMethod" value="razorpay"> Razorpay</label>
											</div>
										</div>
									</div>
									<div class="form-group">
										<div class="col-md-12">
											<div class="radio">
												<label for="payment"><input type="radio" id="wallet"
														name="paymentMethod" value="wallet"> Wallet</label>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-12 text-center">
								<p><a href="#" class="btn btn-primary" onclick="proceed(event)">Place an order</a></p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<form id="orderForm" action="/createOrder" method="POST" style="display:none;">
			<input type="hidden" name="selectedAddress" id="formSelectedAddress">
			<input type="hidden" name="paymentMethod" id="formPaymentMethod">
			<input type="hidden" name="totalprice" id="formTotalPrice" value="<%= grandTotal %>">
		</form>
		<!-- add address modal -->
		<style>
			.modal-dialog {
				max-width: 600px;
			}

			.modal-content {
				height: 400px;
				/* Set the height you desire */
				overflow-y: auto;
				/* Add scroll if the content overflows */
			}
		</style>
		<div class="modal fade" id="billingModal" tabindex="-1" role="dialog" aria-labelledby="billingModalLabel"
			aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="billingModalLabel">Add New Address</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<form id="addressForm" method="post" action="/checkout" onsubmit="return validateForm()">
							<div class="form-group">
								<label for="name">Name</label>
								<input type="text" class="form-control" id="name" name="name" required>
								<small id="nameError" class="form-text text-danger" style="display: none;">Please enter
									a valid name.</small>
							</div>
							<div class="form-group">
								<label for="house">House</label>
								<input type="text" class="form-control" id="house" name="house" required>
								<small id="houseError" class="form-text text-danger" style="display: none;">Please enter
									a valid house number.</small>
							</div>
							<div class="form-group">
								<label for="locality">Locality</label>
								<input type="text" class="form-control" id="locality" name="locality" required>
								<small id="localityError" class="form-text text-danger" style="display: none;">Please
									enter a valid locality.</small>
							</div>

							<div class="form-group">
								<label for="city">City</label>
								<input type="text" class="form-control" id="city" name="city" required>
								<small id="cityError" class="form-text text-danger" style="display: none;">Please enter
									a valid city.</small>
							</div>
							<div class="form-group">
								<label for="state">State</label>
								<input type="text" class="form-control" id="state" name="state" required>
								<small id="stateError" class="form-text text-danger" style="display: none;">Please enter
									a valid state.</small>
							</div>
							<div class="form-group">
								<label for="pincode">Pincode</label>
								<input type="text" class="form-control" id="pincode" name="pincode" required>
								<small id="pincodeError" class="form-text text-danger" style="display: none;">Please
									enter a valid pincode.</small>
							</div>
							<div class="form-group">
								<label for="mobile">Mobile</label>
								<input type="text" class="form-control" id="mobile" name="mobile" required>
								<small id="mobileError" class="form-text text-danger" style="display: none;">Please
									enter a valid mobile number.</small>
							</div>
							<button type="submit" class="btn btn-primary">Save Address</button>
						</form>
					</div>
				</div>
			</div>
		</div>


		<footer id="colorlib-footer" role="contentinfo">
			<div class="container">
				<div class="row row-pb-md">
					<div class="col footer-col colorlib-widget">
						<h4>About Headphones</h4>
						<p>Even the all-powerful Pointing has no control about the blind texts it is an almost
							unorthographic life</p>
						<p>
						<ul class="colorlib-social-icons">
							<li><a href="#"><i class="icon-twitter"></i></a></li>
							<li><a href="#"><i class="icon-facebook"></i></a></li>
							<li><a href="#"><i class="icon-linkedin"></i></a></li>
							<li><a href="#"><i class="icon-dribbble"></i></a></li>
						</ul>
						</p>
					</div>
					<div class="col footer-col colorlib-widget">
						<h4>Customer Care</h4>
						<p>
						<ul class="colorlib-footer-links">
							<li><a href="#">Contact</a></li>
							<li><a href="#">Returns/Exchange</a></li>
							<li><a href="#">Gift Voucher</a></li>
							<li><a href="#">Wishlist</a></li>
							<li><a href="#">Special</a></li>
							<li><a href="#">Customer Services</a></li>
							<li><a href="#">Site maps</a></li>
						</ul>
						</p>
					</div>
					<div class="col footer-col colorlib-widget">
						<h4>Information</h4>
						<p>
						<ul class="colorlib-footer-links">
							<li><a href="#">About us</a></li>
							<li><a href="#">Delivery Information</a></li>
							<li><a href="#">Privacy Policy</a></li>
							<li><a href="#">Support</a></li>
							<li><a href="#">Order Tracking</a></li>
						</ul>
						</p>
					</div>

					<div class="col footer-col">
						<h4>News</h4>
						<ul class="colorlib-footer-links">
							<li><a href="blog.html">Blog</a></li>
							<li><a href="#">Press</a></li>
							<li><a href="#">Exhibitions</a></li>
						</ul>
					</div>

					<div class="col footer-col">
						<h4>Contact Information</h4>
						<ul class="colorlib-footer-links">
							<li>291 South 21th Street, <br> Suite 721 New York NY 10016</li>
							<li><a href="tel://1234567920">+ 1235 2355 98</a></li>
							<li><a href="mailto:info@yoursite.com">info@yoursite.com</a></li>
							<li><a href="#">yoursite.com</a></li>
						</ul>
					</div>
				</div>
			</div>
			<div class="copy">
				<div class="row">
					<div class="col-sm-12 text-center">
						<p>
							<span><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
								Copyright &copy;
								<script>document.write(new Date().getFullYear());</script> All rights reserved | This
								template is made with <i class="icon-heart" aria-hidden="true"></i> by <a
									href="https://colorlib.com" target="_blank">Colorlib</a>
								<!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
							</span>
							<span class="block">Demo Images: <a href="http://unsplash.co/" target="_blank">Unsplash</a>
								, <a href="http://pexels.com/" target="_blank">Pexels.com</a></span>
						</p>
					</div>
				</div>
			</div>
		</footer>
	</div>

	<div class="gototop js-top">
		<a href="#" class="js-gotop"><i class="ion-ios-arrow-up"></i></a>
	</div>

	<!-- jQuery -->
	<script src="/static/userImages/js/jquery.min.js"></script>
	<!-- popper -->
	<script src="/static/userImages/js/popper.min.js"></script>
	<!-- bootstrap 4.1 -->
	<script src="/static/userImages/js/bootstrap.min.js"></script>
	<!-- jQuery easing -->
	<script src="/static/userImages/js/jquery.easing.1.3.js"></script>
	<!-- Waypoints -->
	<script src="/static/userImages/js/jquery.waypoints.min.js"></script>
	<!-- Flexslider -->
	<script src="/static/userImages/js/jquery.flexslider-min.js"></script>
	<!-- Owl carousel -->
	<script src="/static/userImages/js/owl.carousel.min.js"></script>
	<!-- Magnific Popup -->
	<script src="/static/userImages/js/jquery.magnific-popup.min.js"></script>
	<script src="/static/userImages/js/magnific-popup-options.js"></script>
	<!-- Date Picker -->
	<script src="/static/userImages/js/bootstrap-datepicker.js"></script>
	<!-- Stellar Parallax -->
	<script src="/static/userImages/js/jquery.stellar.min.js"></script>
	<!-- Main -->
	<script src="/static/userImages/js/main.js"></script>

	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script src="https://checkout.razorpay.com/v1/checkout.js"></script>


	<script>
		function validateForm() {
			const name = document.getElementById('name').value.trim();
			const house = document.getElementById('house').value.trim();
			const locality = document.getElementById('locality').value.trim();
			const city = document.getElementById('city').value.trim();
			const state = document.getElementById('state').value.trim();
			const pincode = document.getElementById('pincode').value.trim();
			const mobile = document.getElementById('mobile').value.trim();

			let isValid = true;

			if (!name.match(/^[a-zA-Z\s]+$/)) {
				document.getElementById('nameError').style.display = 'block';
				isValid = false;
			} else {
				document.getElementById('nameError').style.display = 'none';
			}

			if (!house.match(/^[a-zA-Z\s\d]+$/)) {
				document.getElementById('houseError').style.display = 'block';
				isValid = false;
			} else {
				document.getElementById('houseError').style.display = 'none';
			}

			if (!locality.match(/^[a-zA-Z\s]+$/)) {
				document.getElementById('localityError').style.display = 'block';
				isValid = false;
			} else {
				document.getElementById('localityError').style.display = 'none';
			}

			if (!mobile.match(/^[1-9]\d{9}$/)) {
				document.getElementById('mobileError').style.display = 'block';
				isValid = false;
			} else {
				document.getElementById('mobileError').style.display = 'none';
			}

			if (!pincode.match(/^[1-9]\d{5}$/)) {
				document.getElementById('pincodeError').style.display = 'block';
				isValid = false;
			} else {
				document.getElementById('pincodeError').style.display = 'none';
			}

			if (!city.match(/^[a-zA-Z\s]+$/)) {
				document.getElementById('cityError').style.display = 'block';
				isValid = false;
			} else {
				document.getElementById('cityError').style.display = 'none';
			}

			if (!state.match(/^[a-zA-Z\s]+$/)) {
				document.getElementById('stateError').style.display = 'block';
				isValid = false;
			} else {
				document.getElementById('stateError').style.display = 'none';
			}

			return isValid;
		}

		const stockCheck = () => {
			return axios.get("/checkStock")
				.then((response) => {
					if (response.data.success) {
						return true;
					} else {
						Swal.fire({
							title: "Warning",
							text: response.data.message,
							icon: "warning",
							confirmButtonText: "Ok"
						}).then((result) => {
							if (result.isConfirmed) {
								window.location = "/cart";
							}
						});
						return false;
					}
				})
				.catch((error) => {
					Swal.fire(
						"Error",
						"Oops..Something went wrong",
						"error"
					);
					return false;
				});
		};

		const proceed = (event) => {
			event.preventDefault();
			const selectedAddress = document.querySelector("input[name='selectedAddress']:checked");
			if (!selectedAddress) {
				Swal.fire(
					"Select an address to proceed",
					"",
					"warning"
				);
				return false;
			}

			const selectedPaymentMethod = document.querySelector("input[name='paymentMethod']:checked");
			if (!selectedPaymentMethod) {
				Swal.fire(
					"Select a payment method to proceed",
					"",
					"warning"
				);
				return false;
			}

			stockCheck().then((isStockAvailabale) => {
				if (!isStockAvailabale) {
					return;
				}
				Swal.fire({
					title: 'Are you sure?',
					text: 'The order will get placed',
					icon: 'warning',
					showCancelButton: true,
					confirmButtonText: 'Yes',
					cancelButtonText: 'Cancel',
					reverseButtons: true
				}).then((result) => {
					if (result.isConfirmed) {
						const formData = {
							selectedAddress: selectedAddress.value,
							paymentMethod: selectedPaymentMethod.value,
							totalprice: document.querySelector("input[name='totalprice']").value
						};
						axios.post("/createOrder", formData).then((response) => {
							if (response.data.success && selectedPaymentMethod.value === 'razorpay') {
								let options = {
									"key": response.data.key_id,
									"amount": response.data.amount,
									"currency": "INR",
									"name": "AUDIZO.",
									"description": "Test Transaction",
									"order_id": response.data.order_id,
									"handler": function (response) {
										if (response.error) {
											window.location.href = "/cart";
										} else if (response.razorpay_payment_id) {
											window.location.href = "/orderSuccess";
										}
									},
									"notes": {
										"address": "Razorpay Corporate Office"
									},
									"theme": {
										"color": "#F37254"
									}
								};
								let rzp1 = new Razorpay(options);
								rzp1.open();
								rzp1.on('cart', (response) => {
									setTimeout(() => {
										rzp1.close();
										window.location.href = "/cart";
									}, 3000);
								});

							} else if (response.data.success && selectedPaymentMethod.value === 'cod') {
								if (response.data.message === "cannot place order in cod") {
									document.getElementById("codError").style.display = "block";
									return false;
								}

								window.location.href = "/orderSuccess";

							} else {
								Swal.fire(
									'Error!',
									'An error occurred while placing the order.',
									'error'
								);
							}
						}).catch((error) => {
							console.error('Error placing the order:', error);
							Swal.fire(
								'Error!',
								'An error occurred while placing the order.',
								'error'
							);
						})
					}
				})
			})


		}



	</script>
</body>

</html>